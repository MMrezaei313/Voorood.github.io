<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم حضور و غیاب شیفت</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background: linear-gradient(135deg, #3498db, #1a73e8);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: #3498db;
            border: none;
        }
        
        .table th {
            background-color: #2c3e50;
            color: white;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .persian-date {
            font-family: 'Vazir', sans-serif;
            direction: rtl;
        }
        
        .koor-header {
            background-color: #e9ecef;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- صفحه ورود -->
        <div id="login-page" v-if="!loggedIn">
            <div class="login-container">
                <h2 class="text-center mb-4">ورود به سیستم حضور و غیاب</h2>
                <form @submit.prevent="login">
                    <div class="mb-3">
                        <label for="username" class="form-label">نام کاربری</label>
                        <input type="text" class="form-control" id="username" v-model="loginData.username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">رمز عبور</label>
                        <input type="password" class="form-control" id="password" v-model="loginData.password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">نقش کاربری</label>
                        <select class="form-select" id="role" v-model="loginData.role" required>
                            <option value="admin">ادمین</option>
                            <option value="supervisor">سرپرست شیفت</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ورود به سیستم</button>
                </form>
                <div class="mt-3 p-2 bg-light rounded">
                    <h6 class="text-center">اطلاعات ورود:</h6>
                    <p class="mb-1">ادمین: admin / admin123</p>
                    <p class="mb-0">سرپرست: supervisor / sup123</p>
                </div>
            </div>
        </div>

        <!-- صفحه اصلی بعد از ورود -->
        <div id="main-page" v-else>
            <!-- هدر -->
            <div class="header text-center">
                <h1>سیستم حضور و غیاب شیفت</h1>
                <p>کاربر: {{ currentUser.name }} ({{ currentUser.role === 'admin' ? 'ادمین' : 'سرپرست شیفت' }})</p>
                <p class="persian-date">امروز: {{ currentJalaliDate }}</p>
                <button class="btn btn-light btn-sm" @click="logout">خروج</button>
            </div>

            <!-- تب‌ها -->
            <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                <li class="nav-item" role="presentation" v-if="currentUser.role === 'admin'">
                    <button class="nav-link" :class="{ active: activeTab === 'personnel' }" @click="activeTab = 'personnel'">مدیریت پرسنل</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ active: activeTab === 'attendance' }" @click="activeTab = 'attendance'">ثبت حضور و غیاب</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" :class="{ active: activeTab === 'reports' }" @click="activeTab = 'reports'">گزارشات</button>
                </li>
            </ul>

            <!-- مدیریت پرسنل (فقط برای ادمین) -->
            <div v-if="activeTab === 'personnel' && currentUser.role === 'admin'" class="tab-pane fade show active">
                <div class="card">
                    <div class="card-header">مدیریت پرسنل</div>
                    <div class="card-body">
                        <form @submit.prevent="addPersonnel" class="mb-4">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="name" class="form-label">نام</label>
                                    <input type="text" class="form-control" id="name" v-model="newPersonnel.name" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="family" class="form-label">نام خانوادگی</label>
                                    <input type="text" class="form-control" id="family" v-model="newPersonnel.family" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="personnelCode" class="form-label">شماره پرسنلی</label>
                                    <input type="text" class="form-control" id="personnelCode" v-model="newPersonnel.personnelCode" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="position" class="form-label">پست سازمانی</label>
                                    <select class="form-select" id="position" v-model="newPersonnel.position" required>
                                        <option v-for="(positions, koor) in koorPositions" :key="koor">
                                            <optgroup :label="koor">
                                                <option v-for="position in positions" :value="position">{{ position }}</option>
                                            </optgroup>
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success mt-3">افزودن پرسنل</button>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>شماره پرسنلی</th>
                                        <th>نام و نام خانوادگی</th>
                                        <th>پست سازمانی</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="personnel in personnels" :key="personnel.id">
                                        <td>{{ personnel.personnelCode }}</td>
                                        <td>{{ personnel.name }} {{ personnel.family }}</td>
                                        <td>{{ personnel.position }}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" @click="deletePersonnel(personnel.id)">حذف</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ثبت حضور و غیاب -->
            <div v-if="activeTab === 'attendance'" class="tab-pane fade show active">
                <div class="card">
                    <div class="card-header">ثبت حضور و غیاب شیفت</div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="shiftDate" class="form-label">تاریخ</label>
                                <input type="date" class="form-control" id="shiftDate" v-model="attendanceData.date" required>
                                <div class="persian-date mt-2">{{ jalaliDate }}</div>
                            </div>
                            <div class="col-md-4">
                                <label for="shiftType" class="form-label">نوع شیفت</label>
                                <select class="form-select" id="shiftType" v-model="attendanceData.shiftType" required>
                                    <option value="صبح (۶-۱۴)">صبح (۶-۱۴)</option>
                                    <option value="عصر (۱۴-۲۲)">عصر (۱۴-۲۲)</option>
                                    <option value="شب (۲۲-۶)">شب (۲۲-۶)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="supervisor" class="form-label">سرپرست شیفت</label>
                                <input type="text" class="form-control" id="supervisor" v-model="attendanceData.supervisor" required>
                            </div>
                        </div>

                        <div v-for="(positions, koor) in koorPositions" :key="koor">
                            <div class="koor-header">{{ koor }}</div>
                            <div class="mb-3" v-for="position in positions" :key="position">
                                <label class="form-label">{{ position }}</label>
                                <div v-for="(attendance, index) in getAttendanceByPosition(position)" :key="index" class="mb-2 p-2 border rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <select class="form-select" v-model="attendance.personnelId">
                                                <option value="">انتخاب پرسنل</option>
                                                <option v-for="p in getPersonnelByPosition(position)" :value="p.id" :key="p.id">{{ p.name }} {{ p.family }} ({{ p.personnelCode }})</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" :name="'status_' + attendance.id" value="present" v-model="attendance.status">
                                                <label class="form-check-label">حاضر</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" :name="'status_' + attendance.id" value="leave" v-model="attendance.status">
                                                <label class="form-check-label">مرخصی</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" v-model="attendance.overtime">
                                                <label class="form-check-label">اضافه کار</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" v-model="attendance.substitute">
                                                <label class="form-check-label">تعویض</label>
                                            </div>
                                            <div v-if="attendance.substitute" class="mt-2">
                                                <input type="text" class="form-control form-control-sm" placeholder="با چه کسی تعویض شده؟" v-model="attendance.substituteWith">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" @click="addAnotherPersonnel(position)">+ افزودن پرسنل دیگر برای این پست</button>
                            </div>
                        </div>

                        <button class="btn btn-success mt-4" @click="saveAttendance">ذخیره اطلاعات حضور و غیاب</button>
                    </div>
                </div>
            </div>

            <!-- گزارشات -->
            <div v-if="activeTab === 'reports'" class="tab-pane fade show active">
                <div class="card">
                    <div class="card-header">گزارشات حضور و غیاب</div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label for="startDate" class="form-label">از تاریخ</label>
                                <input type="date" class="form-control" id="startDate" v-model="reportData.startDate">
                                <div class="persian-date mt-2" v-if="reportData.startDate">{{ toJalali(reportData.startDate) }}</div>
                            </div>
                            <div class="col-md-3">
                                <label for="endDate" class="form-label">تا تاریخ</label>
                                <input type="date" class="form-control" id="endDate" v-model="reportData.endDate">
                                <div class="persian-date mt-2" v-if="reportData.endDate">{{ toJalali(reportData.endDate) }}</div>
                            </div>
                            <div class="col-md-3">
                                <label for="reportShift" class="form-label">شیفت</label>
                                <select class="form-select" id="reportShift" v-model="reportData.shiftType">
                                    <option value="">همه شیفت‌ها</option>
                                    <option value="صبح (۶-۱۴)">صبح (۶-۱۴)</option>
                                    <option value="عصر (۱۴-۲۲)">عصر (۱۴-۲۲)</option>
                                    <option value="شب (۲۲-۶)">شب (۲۲-۶)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label d-block">&nbsp;</label>
                                <button class="btn btn-primary" @click="generateReport"> تولید گزارش</button>
                            </div>
                        </div>

                        <div class="table-responsive" v-if="reportResults.length">
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                        <th>تاریخ (شمسی)</th>
                                        <th>شیفت</th>
                                        <th>پرسنل</th>
                                        <th>پست سازمانی</th>
                                        <th>وضعیت</th>
                                        <th>اضافه کار</th>
                                        <th>تعویض با</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, index) in reportResults" :key="index">
                                        <td>{{ toJalali(item.date) }}</td>
                                        <td>{{ item.shiftType }}</td>
                                        <td>{{ item.personnelName }}</td>
                                        <td>{{ item.position }}</td>
                                        <td>
                                            <span class="badge" :class="{
                                                'bg-success': item.status === 'present',
                                                'bg-warning': item.status === 'leave'
                                            }">
                                                {{ item.status === 'present' ? 'حاضر' : 'مرخصی' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info" v-if="item.overtime">اضافه کار</span>
                                            <span v-else>-</span>
                                        </td>
                                        <td>{{ item.substituteWith || '-' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div v-else class="alert alert-info">
                            گزارشی برای نمایش وجود ندارد. لطفا فیلترهای مورد نظر خود را اعمال کنید.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        
        createApp({
            setup() {
                // وضعیت ورود کاربر
                const loggedIn = ref(false);
                const currentUser = ref({});
                const activeTab = ref('attendance');
                
                // داده‌های ورود
                const loginData = reactive({
                    username: '',
                    password: '',
                    role: 'admin'
                });
                
                // داده‌های پرسنل
                const personnels = ref([]);
                const newPersonnel = reactive({
                    name: '',
                    family: '',
                    personnelCode: '',
                    position: ''
                });
                
                // داده‌های حضور و غیاب
                const attendanceData = reactive({
                    date: new Date().toISOString().split('T')[0],
                    shiftType: 'صبح (۶-۱۴)',
                    supervisor: ''
                });
                
                const attendanceRecords = ref([]);
                
                // داده‌های گزارش
                const reportData = reactive({
                    startDate: '',
                    endDate: '',
                    shiftType: ''
                });
                
                const reportResults = ref([]);
                
                // تعریف پست‌های سازمانی
                const koorPositions = {
                    "کوره یک": [
                        "ذوبکار کوره یک",
                        "متصدی ماشین خط یک",
                        "متصدی لهر خط یک",
                        "متصدی برش و شیشه گیری خط یک"
                    ],
                    "کوره دو": [
                        "ذوبکار کوره دو",
                        "متصدی ماشین خط دو",
                        "متصدی ماشین خط سه",
                        "متصدی لهر خط دو",
                        "متصدی لهر خط سه",
                        "متصدی برش خط دو و سه",
                        "شیشه گیری خط دو و سه"
                    ]
                };
                
                // تاریخ شمسی
                const currentJalaliDate = computed(() => {
                    return toJalali(new Date().toISOString().split('T')[0]);
                });
                
                const jalaliDate = computed(() => {
                    return toJalali(attendanceData.date);
                });
                
                function toJalali(gregorianDate) {
                    if (!gregorianDate) return '';
                    const [year, month, day] = gregorianDate.split('-');
                    
                    // تبدیل تاریخ میلادی به شمسی (ساده‌شده)
                    // این یک تبدیل ساده است و برای دقت بیشتر باید از کتابخانه‌های تخصصی استفاده کرد
                    const jd = parseInt((((parseInt(year) + 621) * 12 + parseInt(month)) * 30 + parseInt(day)) / 30.6);
                    const jy = jd - 621;
                    const jm = (jd - jy * 12) + 1;
                    const jd2 = jd - (jy * 12 + jm) * 30;
                    
                    return `${jy}/${jm < 10 ? '0' + jm : jm}/${jd2 < 10 ? '0' + jd2 : jd2}`;
                }
                
                // توابع مربوط به ورود و خروج
                const login = () => {
                    // بررسی اعتبار کاربر
                    if (loginData.username === 'admin' && loginData.password === 'admin123' && loginData.role === 'admin') {
                        currentUser.value = {
                            name: 'مدیر سیستم',
                            role: 'admin'
                        };
                        loggedIn.value = true;
                        loadFromLocalStorage();
                    } else if (loginData.username === 'supervisor' && loginData.password === 'sup123' && loginData.role === 'supervisor') {
                        currentUser.value = {
                            name: 'سرپرست شیفت',
                            role: 'supervisor'
                        };
                        loggedIn.value = true;
                        loadFromLocalStorage();
                    } else {
                        alert('نام کاربری یا رمز عبور اشتباه است');
                    }
                };
                
                const logout = () => {
                    loggedIn.value = false;
                    currentUser.value = {};
                    loginData.username = '';
                    loginData.password = '';
                    loginData.role = 'admin';
                };
                
                // توابع مدیریت پرسنل
                const addPersonnel = () => {
                    const newId = Date.now().toString();
                    personnels.value.push({
                        id: newId,
                        name: newPersonnel.name,
                        family: newPersonnel.family,
                        personnelCode: newPersonnel.personnelCode,
                        position: newPersonnel.position
                    });
                    
                    // ریست فرم
                    newPersonnel.name = '';
                    newPersonnel.family = '';
                    newPersonnel.personnelCode = '';
                    newPersonnel.position = '';
                    
                    saveToLocalStorage();
                };
                
                const deletePersonnel = (id) => {
                    personnels.value = personnels.value.filter(p => p.id !== id);
                    saveToLocalStorage();
                };
                
                const getPersonnelByPosition = (position) => {
                    return personnels.value.filter(p => p.position === position);
                };
                
                // توابع حضور و غیاب
                const getAttendanceByPosition = (position) => {
                    return attendanceRecords.value.filter(a => a.position === position && a.date === attendanceData.date && a.shiftType === attendanceData.shiftType);
                };
                
                const addAnotherPersonnel = (position) => {
                    attendanceRecords.value.push({
                        id: Date.now().toString(),
                        date: attendanceData.date,
                        shiftType: attendanceData.shiftType,
                        position: position,
                        personnelId: '',
                        status: 'present',
                        overtime: false,
                        substitute: false,
                        substituteWith: ''
                    });
                };
                
                const saveAttendance = () => {
                    // ذخیره اطلاعات حضور و غیاب
                    saveToLocalStorage();
                    alert('اطلاعات حضور و غیاب با موفقیت ذخیره شد.');
                };
                
                // توابع گزارش‌گیری
                const generateReport = () => {
                    let results = [...attendanceRecords.value];
                    
                    // فیلتر بر اساس تاریخ
                    if (reportData.startDate) {
                        results = results.filter(r => r.date >= reportData.startDate);
                    }
                    
                    if (reportData.endDate) {
                        results = results.filter(r => r.date <= reportData.endDate);
                    }
                    
                    // فیلتر بر اساس شیفت
                    if (reportData.shiftType) {
                        results = results.filter(r => r.shiftType === reportData.shiftType);
                    }
                    
                    // افزودن اطلاعات پرسنل
                    results = results.map(record => {
                        const personnel = personnels.value.find(p => p.id === record.personnelId);
                        return {
                            ...record,
                            personnelName: personnel ? `${personnel.name} ${personnel.family}` : 'نامشخص'
                        };
                    });
                    
                    reportResults.value = results;
                };
                
                // توابع ذخیره و بازیابی از localStorage
                const saveToLocalStorage = () => {
                    localStorage.setItem('personnels', JSON.stringify(personnels.value));
                    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords.value));
                };
                
                const loadFromLocalStorage = () => {
                    const savedPersonnels = localStorage.getItem('personnels');
                    const savedAttendance = localStorage.getItem('attendanceRecords');
                    
                    if (savedPersonnels) {
                        personnels.value = JSON.parse(savedPersonnels);
                    }
                    
                    if (savedAttendance) {
                        attendanceRecords.value = JSON.parse(savedAttendance);
                    }
                };
                
                // مقداردهی اولیه
                onMounted(() => {
                    // ایجاد برخی داده‌های نمونه برای نمایش
                    if (localStorage.getItem('personnels') === null) {
                        personnels.value = [
                            { id: '1', name: 'علی', family: 'رضایی', personnelCode: '1001', position: 'ذوبکار کوره یک' },
                            { id: '2', name: 'محمد', family: 'محمدی', personnelCode: '1002', position: 'متصدی ماشین خط یک' },
                            { id: '3', name: 'حسن', family: 'حسینی', personnelCode: '1003', position: 'ذوبکار کوره دو' },
                            { id: '4', name: 'رضا', family: 'کریمی', personnelCode: '1004', position: 'متصدی برش خط دو و سه' }
                        ];
                    }
                    
                    if (localStorage.getItem('attendanceRecords') === null) {
                        attendanceRecords.value = [];
                    }
                    
                    // تنظیم تاریخ پیش‌فرض برای گزارش به ۷ روز گذشته
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    reportData.startDate = sevenDaysAgo.toISOString().split('T')[0];
                    reportData.endDate = new Date().toISOString().split('T')[0];
                });
                
                return {
                    loggedIn,
                    currentUser,
                    activeTab,
                    loginData,
                    personnels,
                    newPersonnel,
                    attendanceData,
                    reportData,
                    reportResults,
                    koorPositions,
                    currentJalaliDate,
                    jalaliDate,
                    login,
                    logout,
                    addPersonnel,
                    deletePersonnel,
                    getPersonnelByPosition,
                    getAttendanceByPosition,
                    addAnotherPersonnel,
                    saveAttendance,
                    generateReport,
                    toJalali
                };
            }
        }).mount('#app');
    </script>
</body>
</html>